{% extends "admin/admin_base.html" %}
{% import "admin/components/pagination.html" as pagination_macros %}

{% block title %}จัดการการประชุม{% endblock %}

{% block admin_content %}

    <h1 class="ui header">
        <i class="calendar icon"></i>
        <div class="content">
            จัดการการประชุม
            <div class="sub header">สร้างและจัดการการประชุมทั้งหมด</div>
        </div>
    </h1>

    <div class="ui segment">
        <a href="{{ url_for('admin.create_meeting') }}" class="ui primary button">
            <i class="plus icon"></i> สร้างการประชุมใหม่
        </a>
        <div class="ui right floated label">
            ทั้งหมด {{ meetings.total }} การประชุม
        </div>
    </div>

    <table class="ui celled table">
        <thead>
            <tr>
                <th>ID</th>
                <th>หัวข้อการประชุม</th>
                <th>วันที่</th>
                <th>เวลา</th>
                <th>สถานที่</th>
                <th>สถานะ</th>
                <th>การดำเนินการ</th>
            </tr>
        </thead>
        <tbody>
            {% for meeting in meetings.items %}
            <tr>
                <td>{{ meeting.id }}</td>
                <td>{{ meeting.topic }}</td>
                <td>{{ meeting.meeting_date.strftime('%d/%m/%Y') }}</td>
                <td>{{ meeting.start_time.strftime('%H:%M') }} - {{ meeting.end_time.strftime('%H:%M') }}</td>
                <td>ห้อง {{ meeting.room }} ชั้น {{ meeting.floor }} อาคาร {{ meeting.building }}</td>
                <td>
                    {% if meeting.is_active %}
                        <div class="ui green label">เปิดลงทะเบียน</div>
                    {% else %}
                        <div class="ui label">ปิด</div>
                    {% endif %}
                </td>
                <td>
                    <div class="ui small buttons">
                        <a href="{{ url_for('admin.view_registrations', meeting_id=meeting.id) }}" 
                           class="ui button" title="ดูผู้ลงทะเบียน">
                            <i class="list icon"></i>
                        </a>
                        <a href="{{ url_for('admin.edit_meeting', meeting_id=meeting.id) }}" 
                           class="ui blue button" title="แก้ไข">
                            <i class="edit icon"></i>
                        </a>
                        <a href="{{ url_for('admin.toggle_meeting', meeting_id=meeting.id) }}" 
                           class="ui button" title="{% if meeting.is_active %}ปิด{% else %}เปิด{% endif %}">
                            {% if meeting.is_active %}
                                <i class="lock icon"></i>
                            {% else %}
                                <i class="unlock icon"></i>
                            {% endif %}
                        </a>
                        <button class="ui red button delete-meeting" 
                            data-meeting-id="{{ meeting.id }}"
                            data-meeting-topic="{{ meeting.topic }}"
                            data-delete-url="{{ url_for('admin.delete_meeting', meeting_id=meeting.id) }}"
                            title="ลบ">
                            <i class="trash icon"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="7" class="center aligned">ยังไม่มีการประชุม</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <!-- Pagination -->
    {{ pagination_macros.render_pagination(meetings, 'admin.meetings') }}

    <!-- Delete Confirmation Modal -->
    <div class="ui small modal" id="deleteModal">
        <div class="header">ยืนยันการลบการประชุม</div>
        <div class="content" id="modalContent">
            <p>คุณต้องการลบการประชุม "<span id="meetingTopic"></span>" หรือไม่?</p>
            <div class="ui warning message">
                <i class="warning icon"></i>
                การลบจะไม่สามารถยกเลิกได้ และจะลบได้เฉพาะการประชุมที่ยังไม่มีผู้ลงทะเบียนเท่านั้น
            </div>
        </div>
        <div class="actions">
            <div class="ui black deny button">
                <i class="remove icon"></i>
                ยกเลิก
            </div>
            <div class="ui red approve button" id="confirmDeleteBtn">
                <i class="trash icon"></i>
                ลบการประชุม
            </div>
        </div>
    </div>

{% endblock %}

{% block admin_scripts %}
<script>
$(document).ready(function() {
    // Handle delete button click
    $('.delete-meeting').on('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        var $button = $(this);  // เก็บ reference ของปุ่มที่คลิก
        var meetingId = $button.data('meeting-id');
        var meetingTopic = $button.data('meeting-topic');
        var deleteUrl = $button.data('delete-url');  // ดึง URL จาก data attribute
        
        console.log('Delete URL:', deleteUrl);  // Debug log
        
        // Set modal content
        $('#meetingTopic').text(meetingTopic);
        
        // Reset modal content
        $('#modalContent').html(
            '<p>คุณต้องการลบการประชุม "<span id="meetingTopic">' + meetingTopic + '</span>" หรือไม่?</p>' +
            '<div class="ui warning message">' +
            '<i class="warning icon"></i>' +
            'การลบจะไม่สามารถยกเลิกได้ และจะลบได้เฉพาะการประชุมที่ยังไม่มีผู้ลงทะเบียนเท่านั้น' +
            '</div>'
        );
        $('#confirmDeleteBtn').show();
        $('.deny.button').text('ยกเลิก');
        
        // Configure and show modal
        $('#deleteModal')
            .modal({
                closable: false,
                onDeny: function() {
                    // Just close modal
                    return true;
                },
                onApprove: function() {
                    // Show loading
                    $('#confirmDeleteBtn').addClass('loading disabled');
                    
                    // Submit delete request via AJAX
                    $.ajax({
                        type: 'POST',
                        url: deleteUrl,  // ใช้ deleteUrl ที่ดึงมาจาก data attribute
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        success: function(response) {
                            console.log('Delete success:', response);  // Debug log
                            // Reload page on success
                            window.location.reload();
                        },
                        error: function(xhr) {
                            console.error('Delete error:', xhr);  // Debug log
                            
                            // Remove loading
                            $('#confirmDeleteBtn').removeClass('loading disabled');
                            
                            // Show error message
                            var errorMsg = 'เกิดข้อผิดพลาด';
                            
                            if (xhr.responseJSON && xhr.responseJSON.error) {
                                errorMsg = xhr.responseJSON.error;
                            } else if (xhr.status === 400) {
                                errorMsg = 'ไม่สามารถลบได้ เนื่องจากมีผู้ลงทะเบียนแล้ว';
                            } else if (xhr.status === 404) {
                                errorMsg = 'ไม่พบการประชุมที่ต้องการลบ';
                            } else if (xhr.status === 500) {
                                errorMsg = 'เกิดข้อผิดพลาดจาก Server';
                            }
                            
                            // Update modal content
                            $('#modalContent').html(
                                '<div class="ui negative message">' +
                                '<div class="header">ไม่สามารถลบได้</div>' +
                                '<p>' + errorMsg + '</p>' +
                                '</div>'
                            );
                            
                            // Hide approve button and change deny button text
                            $('#confirmDeleteBtn').hide();
                            $('.deny.button').text('ปิด');
                        }
                    });
                    
                    return false; // Keep modal open
                }
            })
            .modal('show');
    });
});
</script>
{% endblock %}