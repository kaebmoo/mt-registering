{% extends "base.html" %}

{% block title %}แก้ไขการประชุม{% endblock %}

{% block content %}
<div class="ui container">
    <!-- Organizer Menu -->
    <div class="ui secondary menu">
        <a class="item" href="{{ url_for('organizer.dashboard') }}">
            <i class="dashboard icon"></i> Dashboard
        </a>
        <div class="right menu">
            <div class="item">
                <i class="user icon"></i> {{ current_user.email }}
            </div>
            <a class="item" href="{{ url_for('auth.logout') }}">
                <i class="sign out icon"></i> ออกจากระบบ
            </a>
        </div>
    </div>

    <h1 class="ui header">
        <i class="edit icon"></i>
        <div class="content">
            แก้ไขการประชุม
            <div class="sub header">แก้ไขข้อมูลการประชุม</div>
        </div>
    </h1>

    <form class="ui form" method="POST">
        <h4 class="ui dividing header">ข้อมูลพื้นฐาน</h4>
        
        <div class="field">
            <label>หัวข้อการประชุม</label>
            <input type="text" name="topic" value="{{ meeting.topic }}" required>
        </div>
        
        <div class="three fields">
            <div class="field">
                <label>วันที่</label>
                <input type="date" name="meeting_date" 
                       value="{{ meeting.meeting_date.strftime('%Y-%m-%d') }}" required>
            </div>
            <div class="field">
                <label>เวลาเริ่ม</label>
                <input type="time" name="start_time" 
                       value="{{ meeting.start_time.strftime('%H:%M') }}" required>
            </div>
            <div class="field">
                <label>เวลาสิ้นสุด</label>
                <input type="time" name="end_time" 
                       value="{{ meeting.end_time.strftime('%H:%M') }}" required>
            </div>
        </div>
        
        <h4 class="ui dividing header">สถานที่ประชุม</h4>
        
        <div class="field">
            <label>รูปแบบการประชุม</label>
            <select name="meeting_type" class="ui dropdown" id="meeting_type">
                <option value="onsite" {% if meeting.meeting_type == 'onsite' %}selected{% endif %}>ณ สถานที่ (Onsite)</option>
                <option value="online" {% if meeting.meeting_type == 'online' %}selected{% endif %}>ออนไลน์ (Online)</option>
                <option value="hybrid" {% if meeting.meeting_type == 'hybrid' %}selected{% endif %}>ผสมผสาน (Hybrid)</option>
            </select>
        </div>
        
        <div id="onsite_fields">
            <div class="three fields">
                <div class="field">
                    <label>ห้องประชุม</label>
                    <input type="text" name="room" value="{{ meeting.room }}">
                </div>
                <div class="field">
                    <label>ชั้น</label>
                    <input type="text" name="floor" value="{{ meeting.floor }}">
                </div>
                <div class="field">
                    <label>อาคาร</label>
                    <input type="text" name="building" value="{{ meeting.building }}">
                </div>
            </div>
        </div>
        
        <div id="online_fields" style="display: none;">
            <h4 class="ui dividing header">ข้อมูลการประชุมออนไลน์</h4>
            
            <div class="field">
                <label>Link การประชุม (Zoom/Teams/Google Meet)</label>
                <input type="url" name="meeting_url" value="{{ meeting.meeting_url }}" placeholder="https://zoom.us/j/123456789">
                <small class="ui grey text">กรอก URL เต็มของการประชุมออนไลน์</small>
            </div>
            
            <div class="two fields">
                <div class="field">
                    <label>Meeting ID</label>
                    <input type="text" name="meeting_id" value="{{ meeting.meeting_id }}" placeholder="123-456-789">
                </div>
                <div class="field">
                    <label>Password</label>
                    <input type="text" name="meeting_password" value="{{ meeting.meeting_password }}" placeholder="abc123">
                </div>
            </div>
        </div>
        
        <div class="field">
            <label>ข้อมูลเพิ่มเติม</label>
            <textarea name="additional_info" rows="3" placeholder="เช่น วาระการประชุม, เอกสารประกอบ, หมายเหตุอื่นๆ">{{ meeting.additional_info }}</textarea>
        </div>
        
        <h4 class="ui dividing header">ตั้งค่าการลงทะเบียน</h4>
        
        <div class="field">
            <div class="ui checkbox">
                <input type="checkbox" name="is_public" {% if meeting.is_public %}checked{% endif %}>
                <label>เปิดให้ทุกคนลงทะเบียนได้ (สาธารณะ)</label>
            </div>
            <p class="ui small grey text">
                <i class="info circle icon"></i>
                หากเลือกสาธารณะ: การประชุมจะแสดงในหน้าแรกให้ทุกคนเห็นและลงทะเบียนได้<br>
                หากไม่เลือก: เฉพาะผู้ที่มี link โดยตรงหรือ QR Code เท่านั้นที่จะลงทะเบียนได้
            </p>
        </div>
        
        <div class="field">
            <div class="ui checkbox">
                <input type="checkbox" name="is_active" {% if meeting.is_active %}checked{% endif %}>
                <label>เปิดรับลงทะเบียน</label>
            </div>
            <p class="ui small grey text">
                <i class="info circle icon"></i>
                หากปิด: จะไม่มีใครสามารถลงทะเบียนได้แม้จะมี link หรือ QR Code
            </p>
        </div>
        
        <!-- แสดงข้อมูลการลงทะเบียนปัจจุบัน -->
        <div class="ui info message">
            <div class="header">สถิติการลงทะเบียน</div>
            <p><i class="users icon"></i> มีผู้ลงทะเบียนแล้ว {{ meeting.registrations.count() }} คน</p>
        </div>
        
        <button class="ui primary button" type="submit">
            <i class="save icon"></i> บันทึกการเปลี่ยนแปลง
        </button>
        <a href="{{ url_for('organizer.view_registrations', meeting_id=meeting.id) }}" class="ui green button">
            <i class="list icon"></i> ดูรายชื่อผู้ลงทะเบียน
        </a>
        <a href="{{ url_for('organizer.dashboard') }}" class="ui button">
            <i class="cancel icon"></i> ยกเลิก
        </a>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded - initializing edit meeting form');
    
    // Initialize Semantic UI components ถ้ามี jQuery
    if (typeof $ !== 'undefined') {
        if ($.fn.dropdown) {
            $('.ui.dropdown').dropdown();
        }
        if ($.fn.checkbox) {
            $('.ui.checkbox').checkbox();
        }
    }
    
    // Meeting type field toggle - ใช้ vanilla JavaScript
    var meetingTypeSelect = document.getElementById('meeting_type');
    var onsiteFields = document.getElementById('onsite_fields');
    var onlineFields = document.getElementById('online_fields');
    
    function toggleMeetingFields() {
        if (!meetingTypeSelect || !onsiteFields || !onlineFields) {
            console.error('Required elements not found');
            return;
        }
        
        var type = meetingTypeSelect.value;
        console.log('Meeting type changed to:', type);
        
        if (type === 'onsite') {
            // แสดง onsite, ซ่อน online
            onsiteFields.style.display = 'block';
            onlineFields.style.display = 'none';
            
            // ตั้ง required fields
            onsiteFields.querySelectorAll('input').forEach(function(input) {
                input.required = true;
            });
            onlineFields.querySelectorAll('input').forEach(function(input) {
                input.required = false;
            });
            
        } else if (type === 'online') {
            // ซ่อน onsite, แสดง online
            onsiteFields.style.display = 'none';
            onlineFields.style.display = 'block';
            
            // ตั้ง required fields
            onsiteFields.querySelectorAll('input').forEach(function(input) {
                input.required = false;
            });
            var meetingUrlField = document.querySelector('input[name="meeting_url"]');
            if (meetingUrlField) {
                meetingUrlField.required = true;
            }
            
        } else { // hybrid
            // แสดงทั้งสองอย่าง
            onsiteFields.style.display = 'block';
            onlineFields.style.display = 'block';
            
            // ไม่บังคับ required
            onsiteFields.querySelectorAll('input').forEach(function(input) {
                input.required = false;
            });
            onlineFields.querySelectorAll('input').forEach(function(input) {
                input.required = false;
            });
        }
    }
    
    // เพิ่ม event listener
    if (meetingTypeSelect) {
        meetingTypeSelect.addEventListener('change', toggleMeetingFields);
        
        // เรียกครั้งแรกเพื่อตั้งค่าเริ่มต้น (สำคัญมากสำหรับ Edit)
        toggleMeetingFields();
    }
    
    // Fallback สำหรับกรณีที่มี jQuery
    if (typeof $ !== 'undefined') {
        $(document).ready(function() {
            console.log('jQuery ready - ensuring proper initialization');
            
            // อีกครั้งเพื่อความแน่ใจ
            $('#meeting_type').on('change', function() {
                toggleMeetingFields();
            });
            
            // Trigger เพื่อให้แน่ใจว่าแสดงถูกต้องตาม value ปัจจุบัน
            $('#meeting_type').trigger('change');
        });
    }
});
</script>
{% endblock %}